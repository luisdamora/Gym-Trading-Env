<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gym Trading Env â€” Dashboard</title>
  <script type="text/javascript" src="https://assets.pyecharts.org/assets/echarts.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap"
    rel="stylesheet">
</head>

<style type="text/css">
  body {
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    color: #333333;
  }

  #main {
    display: flex;
    justify-content: center;
    text-align: center;
  }

  #info {
    position: -webkit-sticky;
    position: sticky;
    top: 30px;
    max-width: 300px;
  }

  select {
    padding: 10px;
    border: 1px solid #ededed;
    border-radius: 5%;
    max-width: 100%;
    white-space: nowrap;
    text-overflow: ellipsis;
  }

  #metrics {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
  }

  .metric {
    padding: 10px;
    border: 1px solid #ededed;
    max-width: 110px;
    border-radius: 5%;
  }

  #author {
    color: lightgrey;
    margin-top: 20px;
  }
</style>

<body>
  <div id="main" class="min-h-screen bg-gray-50 text-gray-800">
    <div class="mx-auto max-w-7xl px-4 py-8 lg:py-12">
      <div class="flex flex-col-reverse gap-8 lg:flex-row lg:items-start">
        <div>
          <img
            src="https://raw.githubusercontent.com/ClementPerroud/Gym-Trading-Env/main/docs/source/images/logo_light-bg.png"
            alt="Gym Trading Env" style="max-width: 350px" class="mx-auto lg:mx-0" />
          <div id="chart" style="width:950px; height:900px;"
            class="mt-4 rounded-lg border border-gray-200 bg-white shadow-sm"></div>
        </div>

        <div class="w-full lg:w-[320px]">
          <div id="info" class="lg:sticky lg:top-8">
            <h2 class="text-xl font-semibold">Metrics</h2>
            <div id="metrics" class="mt-3"></div>
            <h2 class="mt-10 text-xl font-semibold">Parameters</h2>
            <p class="mt-2 text-sm text-gray-500">Select render</p>
            <select name='select_dataset' id='select_dataset' method="GET" action="/"
              class="mt-2 w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-left text-gray-700 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500">
              {% for name in render_names|sort %}
              <option value="{{name}}" SELECTED>{{ name }}</option>
              {% endfor %}
            </select>
            <div id="author" class="text-sm">by Luisda</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const chart = echarts.init(document.getElementById('chart'), 'white', { renderer: 'canvas' });

    function setLoadingStates() {
      const metrics = document.getElementById('metrics');
      metrics.innerHTML = '';
      const skel = document.createElement('div');
      skel.className = 'grid grid-cols-2 gap-3';
      for (let i = 0; i < 4; i++) {
        const card = document.createElement('div');
        card.className = 'metric rounded-md border border-gray-200 bg-white p-3 shadow-sm';
        card.innerHTML = '<div class="h-4 w-20 animate-pulse rounded bg-gray-200"></div><div class="mt-2 h-4 w-12 animate-pulse rounded bg-gray-200"></div>';
        skel.appendChild(card);
      }
      metrics.appendChild(skel);
    }

    async function fetchJson(url) {
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error(`Request failed: ${res.status}`);
      return res.json();
    }

    async function fetchDataChart(name = '') {
      try {
        setLoadingStates();
        const base = window.location.origin;
        const chartData = await fetchJson(`${base}/update_data/${encodeURIComponent(name)}`);
        chart.setOption(chartData);

        const metricsData = await fetchJson(`${base}/metrics`);
        const metrics = document.getElementById('metrics');
        metrics.innerHTML = '';

        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-2 gap-3 sm:grid-cols-2 lg:grid-cols-2';

        for (const item of metricsData) {
          const card = document.createElement('div');
          card.className = 'metric rounded-md border border-gray-200 bg-white p-3 text-left shadow-sm';

          const nameEl = document.createElement('p');
          nameEl.className = 'text-sm font-semibold text-gray-700';
          nameEl.textContent = item.name;

          const valueEl = document.createElement('p');
          valueEl.className = 'mt-1 text-base text-gray-900';
          valueEl.textContent = item.value;

          card.appendChild(nameEl);
          card.appendChild(valueEl);
          grid.appendChild(card);
        }
        metrics.appendChild(grid);
      } catch (err) {
        const metrics = document.getElementById('metrics');
        metrics.innerHTML = `<div class="rounded-md border border-red-200 bg-red-50 p-3 text-left text-red-700">Error loading data: ${err.message}</div>`;
        console.error(err);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const select = document.getElementById('select_dataset');
      const initial = select?.value || '';
      fetchDataChart(initial);
      select.addEventListener('change', (e) => fetchDataChart(e.target.value));
      window.addEventListener('resize', () => chart.resize());
    });

  </script>
</body>

</html>